<script type="text/javascript">
  // convert to i18 text

  function c_soop_group(x) {
    return RED._("soopsasm-dashboard/soop_group:soop_group." + x);
  }
  RED.nodes.registerType("soop_group", {
    category: "config",
    defaults: {
      name: {
        value: c_soop_group("label.default"),
      },
      tab: {
        type: "soop_tab",
        required: true,
      },
      order: {
        value: 0,
      },
      displayVisible: {
        value: true,
      },
      width: {
        value: 3,
      },
      height: {
        value: 2,
      },
      groupX: {
        value: 0,
      },
      groupY: {
        value: 0,
      },
      disabled: {
        value: false,
      },
      hidden: {
        value: false,
      },
      groupState: {
        value: new Array(),
      },
      includedNodesId: {
        value: new Array(),
      },
    },
    paletteLabel: "SOOPSASM GROUP",
    label: function () {
      var tabNode = RED.nodes.node(this.tab);
      if (tabNode) {
        return "[" + (tabNode.name || c_soop_group("label.tab")) + "] " + (this.name || c_soop_group("label.group"));
      }
      return "[" + c_soop_group("label.unassigned") + "] " + (this.name || c_soop_group("label.group"));
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    reflectEdit: function (gNode, nodeId) {
      var groupNode = RED.nodes.node(gNode);
      groupNode.includedNodesId = new Array();
      //   console.log("this is groupNode");
      //   console.log(groupNode);
      RED.nodes.eachNode(function (node) {
        if (groupNode.id == node.group && groupNode.includedNodesId.indexOf(node.id) < 0 && node.id !== nodeId) {
          groupNode.includedNodesId.push(node.id);
        }
      });
      groupNode.groupState = new Array(groupNode.height);
      for (var i = 0; i < groupNode.height; i++) {
        groupNode.groupState[i] = Array.from(
          {
            length: groupNode.width,
          },
          () => false,
        );
      }
      for (var i = 0; i < groupNode.includedNodesId.length; i++) {
        var tmpNode = RED.nodes.node(groupNode.includedNodesId[i]);
        var tmpW = parseInt(tmpNode.width);
        var tmpH = parseInt(tmpNode.height);
        var tmpX = parseInt(tmpNode.widgetX);
        var tmpY = parseInt(tmpNode.widgetY);
        for (var j = tmpX; j < tmpX + tmpW; j++) {
          for (var k = tmpY; k < tmpY + tmpH; k++) {
            groupNode.groupState[k][j] = true;
          }
        }
      }
      return groupNode;
    },
    pushNodeToGroupState: function (widgetX, widgetY, width, height, groupId) {
      var tmpGroupNode = RED.nodes.node(groupId);
      for (var j = widgetX; j < widgetX + width; j++) {
        for (var k = widgetY; k < widgetY + height; k++) {
          tmpGroupNode.groupState[k][j] = true;
        }
      }
      return tmpGroupNode;
    },
    oneditprepare: function () {
      console.log("oneditprepare");
      //groupLocationDefaultSetting(this.tab);
    },
  });
</script>
<script type="text/html" data-template-name="soop_group">
  <div class="form-row">
    <label for="node-config-input-name"
      ><i class="fa fa-tag"></i> <span data-i18n="soop_group.label.name"></span
    ></label>
    <input type="text" id="node-config-input-name" />
  </div>
  <div class="form-row">
    <label for="node-config-input-tab"
      ><i class="fa fa-table"></i> <span data-i18n="soop_group.label.tab"></span
    ></label>
    <input type="text" id="node-config-input-tab" />
  </div>

  <div class="form-row">
    <label for="node-config-input-height"><span data-i18n="soop_group.label.height"></span></label>
    <input id="node-config-input-height" />
  </div>
  <div class="form-row">
    <label for="node-config-input-width"><span data-i18n="soop_group.label.width"></span></label>
    <input id="node-config-input-width" />
  </div>
  <div class="form-row">
    <label for="node-config-input-groupX"><span data-i18n="soop_group.label.x"></span></label>
    <input id="node-config-input-groupX" />
  </div>
  <div class="form-row">
    <label for="node-config-input-groupY"><span data-i18n="soop_group.label.y"></span></label>
    <input id="node-config-input-groupY" />
  </div>
  <div class="form-row">
    <input style="margin:10px 0px 10px 102px; width:20px;" type="checkbox" checked id="node-config-input-disp" />
    <label style="width:auto" for="node-config-input-disp"><span data-i18n="soop_group.display-name"></span></label>
  </div>
</script>
